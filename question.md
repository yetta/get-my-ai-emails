# 开发过程问题回顾与分析

根据项目 `get-my-ai-emails` 的开发记录（包含 `pp.md`、日志文件及历史对话），整理出以下在开发过程中遇到的关键问题及解决方案。

## 1. 自动化流程构建
- **核心需求**：如何自动化获取 Gmail 中特定发送者（The Rundown AI）的邮件并同步到 Obsidian？
    - **挑战**：需要整合 Gmail API、LLM 服务（MiniMax/智谱）、HTML 解析与 Obsidian 文件系统。
    - **解决**：构建了标准化的 ETL 流程（Extract 邮件 -> Transform 翻译/Markdown -> Load 保存文件的）。

## 2. 内容解析与优化
- **图片提取问题**（2026-01-16）
    - **问题**：早期的 Markdown 笔记丢失了邮件中的配图，阅读体验不佳。
    - **解决**：在 `html-parser.js` 中增加了图片提取逻辑，使用占位符 `{{IMG:n}}` 保持图文位置，并在保存时下载图片到附件目录。

- **Token 消耗与内容冗余**（2026-01-20）
    - **问题**：邮件全文翻译导致 LLM Token 消耗过大，且包含广告、推广等无关信息。
    - **解决**：
        1. **截取有效范围**：只读取从 "Good morning" 到 "COMMUNITY" 之间的核心内容。
        2. **去除广告**：通过规则过滤掉 "订阅"、"广告" 等无关链接。
        3. **内容精简**：优化 Prompt，避免生成 "邮件" 等冗余关键词。

- **一级新闻生成冗余**（2026-01-20）
    - **问题**：生成的 Markdown 中，第一条核心新闻会被重复生成，且图片引用混乱。
    - **解决**：修复 Prompt 中的循环逻辑和图片占位符对应关系，确保每个要点只出现一次且图片对应准确。

## 3. 开发效率优化
- **调试成本高**（2026-01-17）
    - **问题**：每次调整生成逻辑都要重新请求 Gmail 和 LLM，耗时且浪费 API 配额。
    - **解决**：实现了**本地缓存机制**。
        - `/emails/*.json`：缓存 Gmail 原始数据。
        - `/translated/*.md`：缓存 LLM 翻译结果。
        - 开发时优先读取本地缓存，极大提升了调试效率。

## 4. 稳定性与运维
- **定时任务失败**（2026-01-22）
    - **问题**：定时任务在 2026-01-22 执行失败，日志显示 MiniMax API 出现 `socket hang up` 错误。
    - **分析**：网络波动导致请求连接中断，且原代码缺乏重试机制。
    - **解决**：
        1. 在 `ai-translator.js` 中增加了**指数退避重试机制**（2s, 4s, 8s）。
        2. 将 API 超时时间从 60s 延长至 **120s**，以应对服务响应慢的情况。

## 5. 文档与可视化
- **流程图渲染问题**（2026-01-22）
    - **问题**：
        1. **Mermaid 渲染**：Obsidian 中无法渲染生成的 Mermaid 图表，提示语法错误。
        2. **样式局限**：普通 Mermaid 流程图不够美观，难以满足分享需求。
        3. **尺寸问题**：生成图表过宽导致出现滚动条。
    - **解决**：
        1. **语法修复**：修正 Mermaid 子图（Subgraph）标签的引号语法。
        2. **美化**：引入 `look: 'handDrawn'` 和配色方案模拟手绘风格。
        3. **原生 Excalidraw**：最终编写 Node.js 脚本 `gen_excalidraw.js`，程序化生成了高还原度、可编辑的 `.excalidraw` 原始文件。

## 总结
项目经历了从**功能实现**（能跑通）到**体验优化**（带图、去广告）再到**工程化治理**（缓存、重试、文档）的完整演进过程。目前系统已具备较强的鲁棒性和可维护性。
